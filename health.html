<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding: 30px; background: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-item { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .stat-value { font-size: 1.1rem; color: #2d3436; font-family: monospace; }

        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status-card {
            background: #fff; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 6px solid #dfe6e9;
            transition: transform 0.2s;
        }
        .status-card:hover { transform: translateY(-3px); }
        
        /* Status Colors based on your API "up" string */
        .status-up { border-left-color: #00b894; }
        .status-down { border-left-color: #d63031; }

        .card-head { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .card-head i { font-size: 1.5rem; }
        .card-head h3 { margin: 0; font-size: 1.1rem; color: #2d3436; }

        .indicator { margin-left: auto; font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .bg-up { background: #e6fffb; color: #00b894; }
        .bg-down { background: #fff1f0; color: #d63031; }

        .metric-list { font-size: 0.85rem; border-top: 1px solid #f1f2f6; padding-top: 10px; }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 6px; color: #636e72; }
        .metric-val { color: #2d3436; font-weight: 500; }

        .refresh-btn { 
            background: #0984e3; color: white; border: none; padding: 10px 18px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h2><i class="fas fa-microchip"></i> System Health <small id="version" style="font-size: 0.9rem; color: #888;"></small></h2>
        <button class="refresh-btn" onclick="fetchHealth()">
            <i class="fas fa-sync-alt" id="syncIcon"></i> Refresh
        </button>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-label">Uptime</div>
            <div class="stat-value" id="uptime">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Memory Used (Heap)</div>
            <div class="stat-value" id="memory">-</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">CPU Load (1/5/15m)</div>
            <div class="stat-value" id="cpu">-</div>
        </div>
    </div>

    <div class="health-grid" id="healthGrid"></div>

    <script>
        async function fetchHealth() {
            const syncIcon = document.getElementById('syncIcon');
            syncIcon.classList.add('fa-spin');
            
            try {
                const token = sessionStorage.getItem('jwt_token');
                const baseUrl = "https://app-blue-kappa.vercel.app";
                const response = await fetch(`${baseUrl}/api/system/health`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                renderSystemStats(data);
                renderDependencies(data.dependencies);
            } catch (err) {
                console.error("Health Check Error:", err);
                document.getElementById('healthGrid').innerHTML = `<p style="color:red">Failed to reach health API.</p>`;
            } finally {
                syncIcon.classList.remove('fa-spin');
            }
        }

        function renderSystemStats(data) {
            document.getElementById('version').innerText = `v${data.version}`;
            document.getElementById('uptime').innerText = data.uptime;
            document.getElementById('memory').innerText = data.process.memory.heapUsed;
            document.getElementById('cpu').innerText = data.process.cpuLoad.join(' / ');
        }

        function renderDependencies(deps) {
            const grid = document.getElementById('healthGrid');
            grid.innerHTML = '';

            const icons = {
                database: 'fa-database',
                mongodb: 'fa-leaf',
                externalApi: 'fa-project-diagram'
            };

            for (const [key, details] of Object.entries(deps)) {
                const isUp = details.status === 'up';
                const card = document.createElement('div');
                card.className = `status-card ${isUp ? 'status-up' : 'status-down'}`;
                
                let extraMetrics = '';
                if (details.latency) extraMetrics += `<div class="metric-row"><span>Latency</span><span class="metric-val">${details.latency}</span></div>`;
                if (details.pool) extraMetrics += `<div class="metric-row"><span>Connections</span><span class="metric-val">${details.pool.totalConnections}</span></div>`;

                card.innerHTML = `
                    <div class="card-head">
                        <i class="fas ${icons[key] || 'fa-plug'}"></i>
                        <h3>${key.charAt(0).toUpperCase() + key.slice(1)}</h3>
                        <span class="indicator ${isUp ? 'bg-up' : 'bg-down'}">${details.status.toUpperCase()}</span>
                    </div>
                    <div class="metric-list">
                        ${extraMetrics || '<div class="metric-row"><span>Status</span><span class="metric-val">Connected</span></div>'}
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        // Initial fetch and auto-refresh
        fetchHealth();
        setInterval(fetchHealth, 30000);
    </script>
</body>
</html>