<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - System Health</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --accent: #0984e3;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
        }

        body { padding: 30px; background: var(--bg-page); font-family: 'Segoe UI', Tahoma, sans-serif; color: var(--text-main); }
        
        .header-container { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; }
        
        .host-badge {
            display: inline-flex; align-items: center; background: #dfe6e9; color: #2d3436;
            padding: 2px 10px; border-radius: 4px; font-family: monospace; font-size: 0.75rem;
            margin-left: 10px; vertical-align: middle;
        }

        .timer-info { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; display: flex; justify-content: space-between; }

        .progress-track { width: 100%; height: 6px; background: #dfe6e9; margin-bottom: 25px; border-radius: 3px; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--accent); transition: width 1s linear; }

        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-item { background: var(--bg-card); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-family: 'Courier New', monospace; font-weight: bold; }

        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status-card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 6px solid #dfe6e9; }
        .status-up { border-left-color: var(--success); }
        .status-down { border-left-color: var(--danger); }

        .text-nominal { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-critical { color: var(--danger); animation: pulse 2s infinite; }

        #debugToggle { background: none; border: 1px solid #b2bec3; color: var(--text-muted); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 30px; display: flex; align-items: center; gap: 8px; }
        #rawOutput { display: none; background: #2d3436; color: #fab1a0; padding: 20px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.85rem; overflow-x: auto; margin-top: 10px; white-space: pre-wrap; border: 1px solid #000; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .refresh-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

    <div class="header-container">
        <div>
            <h2><i class="fas fa-heartbeat"></i> System Monitor <span id="hostBadge" class="host-badge">...</span></h2>
            <div style="font-size: 0.85rem; color: var(--text-muted);">
                Last update: <span id="lastCheckTime" style="font-weight: bold;">--:--:--</span> (CET)
                <small id="version" style="margin-left: 10px; color: #b2bec3;"></small>
            </div>
        </div>
        <button class="refresh-btn" onclick="fetchHealth()">
            <i class="fas fa-sync-alt" id="syncIcon"></i> Refresh Now
        </button>
    </div>

    <div style="margin-top: 20px;">
        <div class="timer-info">
            <span>Next auto-refresh</span>
            <span id="timeLeft">--:--</span>
        </div>
        <div class="progress-track"><div id="progressBar"></div></div>
    </div>

    <div class="stats-bar">
        <div class="stat-item"><div class="stat-label">Uptime</div><div id="uptime" class="stat-value">-</div></div>
        <div class="stat-item"><div class="stat-label">Memory Heap</div><div id="memory" class="stat-value">-</div></div>
        <div class="stat-item"><div class="stat-label">CPU Load (1m)</div><div id="cpu" class="stat-value">-</div></div>
    </div>

    <div class="health-grid" id="healthGrid"></div>

    <button id="debugToggle" onclick="toggleDebug()"><i class="fas fa-code"></i> Show Raw JSON</button>
    <pre id="rawOutput"></pre>

    <script>
        let BASE_URL = "";
        let CHECK_INTERVAL = 180; 
        let secondsPassed = 0;
        let timer = null;

        const cetFormatter = new Intl.DateTimeFormat('en-GB', {
            timeZone: 'Europe/Paris',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        });

        function formatSeconds(s) {
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatUptime(uptimeStr) {
            if (!uptimeStr) return "N/A";
            const totalSeconds = parseInt(uptimeStr.replace(/\D/g, ''));
            if (isNaN(totalSeconds)) return uptimeStr;
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${h}h ${m}m ${s}s`;
        }

        async function loadConfig() {
            try {
                const res = await fetch('./config.json');
                const config = await res.json();
                BASE_URL = config.api_host;
                CHECK_INTERVAL = config.check_interval || 180;
                document.getElementById('hostBadge').innerText = BASE_URL;
            } catch (err) {
                document.getElementById('hostBadge').innerText = "Config Error";
                BASE_URL = "http://localhost:3001";
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            secondsPassed = 0;
            
            const bar = document.getElementById('progressBar');
            bar.style.transition = 'none';
            bar.style.width = '0%';
            void bar.offsetWidth; 
            bar.style.transition = 'width 1s linear';

            timer = setInterval(() => {
                secondsPassed++;
                const remaining = CHECK_INTERVAL - secondsPassed;
                document.getElementById('timeLeft').innerText = formatSeconds(remaining);
                document.getElementById('progressBar').style.width = `${(secondsPassed / CHECK_INTERVAL) * 100}%`;
                
                if (secondsPassed >= CHECK_INTERVAL) {
                    fetchHealth();
                }
            }, 1000);
        }

        async function fetchHealth() {
            const syncIcon = document.getElementById('syncIcon');
            syncIcon.classList.add('fa-spin');
            
            // Restart the 180s countdown every time we fetch
            startTimer();

            try {
                const token = sessionStorage.getItem('jwt_token');
                const res = await fetch(`${BASE_URL}/api/system/health`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                document.getElementById('version').innerText = `v${data.version}`;
                document.getElementById('uptime').innerText = formatUptime(data.uptime);
                document.getElementById('memory').innerText = data.process.memory.heapUsed;
                
                const cpuVal = data.process.cpuLoad[0];
                const cpuEl = document.getElementById('cpu');
                cpuEl.innerText = cpuVal;
                cpuEl.className = `stat-value ${cpuVal > 2 ? 'text-critical' : (cpuVal > 1 ? 'text-warning' : 'text-nominal')}`;
                
                document.getElementById('lastCheckTime').innerText = cetFormatter.format(new Date());
                document.getElementById('rawOutput').innerText = JSON.stringify(data, null, 4);
                
                renderDeps(data.dependencies);
            } catch (err) {
                document.getElementById('healthGrid').innerHTML = `
                    <div class="status-card status-down" style="grid-column: 1/-1;">
                        <h3>OFFLINE</h3><p>Could not reach ${BASE_URL}</p>
                    </div>`;
            } finally {
                syncIcon.classList.remove('fa-spin');
            }
        }

        function renderDeps(deps) {
            const grid = document.getElementById('healthGrid');
            grid.innerHTML = '';
            Object.entries(deps).forEach(([name, details]) => {
                const isUp = details.status === 'up' || details.status === 'ok';
                grid.innerHTML += `
                    <div class="status-card ${isUp ? 'status-up' : 'status-down'}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; text-transform:capitalize;">${name}</h3>
                            <span style="font-size:0.7rem; padding:4px 10px; border-radius:20px; font-weight:bold; background:${isUp?'#e6fffb':'#fff1f0'}; color:${isUp?'#00b894':'#d63031'}">
                                ${details.status.toUpperCase()}
                            </span>
                        </div>
                        <div style="margin-top:15px; font-size:0.9rem; color:var(--text-muted)">
                            Latency: <span style="font-family:monospace; font-weight:bold; color:var(--text-main)">${details.latency || 'N/A'}</span>
                        </div>
                    </div>`;
            });
        }

        function toggleDebug() {
            const out = document.getElementById('rawOutput');
            out.style.display = (out.style.display === 'none' || out.style.display === '') ? 'block' : 'none';
        }

        (async () => {
            await loadConfig();
            fetchHealth();
        })();
    </script>
</body>
</html>