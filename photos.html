<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Hub - Instant Gallery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f0f2f5; --bg-card: #ffffff; --text-main: #1c1e21;
            --accent: #1877f2; --danger: #fa383e; --muted: #65676b;
        }
        body { padding: 20px; background: var(--bg-page); font-family: 'Segoe UI', sans-serif; margin: 0; }
        
        /* Stats Dashboard */
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;
        }
        .stat-card i { font-size: 2rem; color: var(--accent); }
        .stat-value { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { color: var(--muted); font-size: 0.85rem; text-transform: uppercase; }

        /* Toolbar & Layout */
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .toolbar { display: flex; gap: 10px; background: white; padding: 10px; border-radius: 8px; align-items: center; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 10px; color: var(--muted); }
        .search-box input { padding: 8px 10px 8px 30px; border: 1px solid #ddd; border-radius: 6px; width: 220px; }

        /* Gallery Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .photo-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: 0.2s; display: flex; flex-direction: column; }
        .photo-card:hover { transform: translateY(-5px); }
        .photo-preview { width: 100%; height: 200px; object-fit: cover; cursor: zoom-in; background: #e4e6eb; display: block; }
        
        .photo-info { padding: 12px; flex-grow: 1; }
        .photo-name { font-weight: bold; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 8px; }
        
        /* Tag/Album Styling */
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; min-height: 24px; }
        .tag-pill { 
            background: #f0f2f5; color: var(--muted); font-size: 0.7rem; 
            padding: 2px 8px; border-radius: 10px; display: flex; align-items: center; gap: 4px;
        }
        .tag-pill i { cursor: pointer; font-size: 0.6rem; }
        .tag-pill i:hover { color: var(--danger); }
        .btn-add-tag { font-size: 0.7rem; color: var(--accent); cursor: pointer; border: 1px dashed var(--accent); padding: 1px 6px; border-radius: 10px; }

        .photo-meta { font-size: 0.75rem; color: var(--muted); margin-top: 12px; display: flex; justify-content: space-between; }
        .photo-actions { display: flex; justify-content: space-around; padding: 8px; background: #fafafa; border-top: 1px solid #eee; }
        .btn-action { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 1.1rem; }
        .btn-action:hover { color: var(--accent); }
        .btn-del:hover { color: var(--danger); }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
        #lightbox img { max-width: 95%; max-height: 90%; object-fit: contain; }
        .close-btn { position: absolute; top: 20px; right: 30px; color: white; font-size: 2.5rem; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="stats-container">
        <div class="stat-card">
            <i class="fas fa-images"></i>
            <div><span class="stat-value" id="stat-count">0</span><span class="stat-label">Photos</span></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-folder-open"></i>
            <div><span class="stat-value" id="stat-albums">0</span><span class="stat-label">Albums</span></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-hdd"></i>
            <div><span class="stat-value" id="stat-size">0.00 MB</span><span class="stat-label">Used</span></div>
        </div>
    </div>

    <div class="header-nav">
        <h2><i class="fas fa-th"></i> Photo Hub</h2>
        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search files or albums..." oninput="debouncedSearch()">
            </div>
            <select id="sortSelect" onchange="fetchPhotos(1)" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                <option value="updatedAt">Newest</option>
                <option value="sizeBytes">Size</option>
                <option value="cleanName">Name</option>
            </select>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px dashed #ccc; margin-bottom: 25px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-upload" style="font-size: 2rem; color: var(--accent);"></i>
        <h3 id="uploadStatus" style="margin: 10px 0 0;">Click to Upload Photos</h3>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="handleUpload(this.files)">
    </div>

    <div id="photoGallery" class="gallery-grid"></div>

    <div id="lightbox">
        <span class="close-btn">&times;</span>
        <img id="lightboxImg">
    </div>

    <script>
        const API_PATH = "http://localhost:3001/api/app/images";
        let currentPage = 1;
        let searchTimeout = null;
        let activeBlobUrl = null;

        window.onload = () => { 
            fetchPhotos(1); 
            updateStats(); 
        };

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchPhotos(1), 400);
        }

        async function updateStats() {
            const token = sessionStorage.getItem('jwt_token');
            const headers = { 'Authorization': `Bearer ${token}` };
            
            try {
                // 1. Fetch File Stats
                const statsRes = await fetch(`${API_PATH}/stats`, { headers });
                const statsResult = await statsRes.json();
                if (statsResult.success && statsResult.summary) {
                    document.getElementById('stat-count').innerText = statsResult.summary.totalFiles;
                    document.getElementById('stat-size').innerText = statsResult.summary.totalSizeMB + ' MB';
                }

                // 2. Fetch Unique Tags (Albums)
                const tagsRes = await fetch(`${API_PATH}/tags`, { headers });
                const tagsResult = await tagsRes.json();
                if (tagsResult.success) {
                    document.getElementById('stat-albums').innerText = tagsResult.data.length;
                }
            } catch (err) { console.error("Stats Error:", err); }
        }

        async function fetchPhotos(page = 1) {
            currentPage = page;
            const container = document.getElementById('photoGallery');
            const token = sessionStorage.getItem('jwt_token');
            const sortBy = document.getElementById('sortSelect').value;
            const search = document.getElementById('searchInput').value;

            try {
                const res = await fetch(`${API_PATH}/list?page=${page}&limit=20&sortBy=${sortBy}&cleanName=${search}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                const photos = result.data || [];
                container.innerHTML = "";

                photos.forEach(photo => {
                    const id = photo._id || photo.id;
                    let thumbUrl = photo.thumbnailData || '';
                    if (thumbUrl && !thumbUrl.startsWith('data:')) {
                        thumbUrl = `data:image/webp;base64,${thumbUrl}`;
                    }

                    const tags = photo.tag_list || [];
                    const tagHtml = tags.map(tag => `
                        <span class="tag-pill">
                            <i class="fas fa-folder small"></i> ${tag} 
                            <i class="fas fa-times" onclick="updateTag('${id}', 'remove', '${tag}')"></i>
                        </span>
                    `).join('');

                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.innerHTML = `
                        <img src="${thumbUrl}" class="photo-preview" onclick="openLightbox('${id}')" onerror="this.src='https://via.placeholder.com/240x200?text=No+Preview'">
                        <div class="photo-info">
                            <div class="photo-name">${photo.cleanName}</div>
                            <div class="tag-container">
                                ${tagHtml}
                                <span class="btn-add-tag" onclick="promptAddTag('${id}')">+ Album</span>
                            </div>
                            <div class="photo-meta">
                                <span>${(photo.sizeBytes / 1024).toFixed(1)} KB</span>
                                <span>${new Date(photo.updatedAt).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="photo-actions">
                            <button class="btn-action" onclick="downloadPhoto('${id}', '${photo.cleanName}')"><i class="fas fa-download"></i></button>
                            <button class="btn-action btn-del" onclick="deletePhoto('${id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) { container.innerHTML = "Error loading gallery."; }
        }

        function promptAddTag(id) {
            const tag = prompt("Enter album name (tag):");
            if (tag && tag.trim()) updateTag(id, 'add', tag.trim());
        }

        async function updateTag(id, action, tag) {
            const token = sessionStorage.getItem('jwt_token');
            try {
                const res = await fetch(`${API_PATH}/${id}/tags`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action, tag })
                });
                const result = await res.json();
                if (result.success) {
                    fetchPhotos(currentPage);
                    updateStats(); // Refresh album count
                }
            } catch (err) { console.error("Tag Update Error:", err); }
        }

        async function openLightbox(id) {
            const token = sessionStorage.getItem('jwt_token');
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            try {
                const res = await fetch(`${API_PATH}/download/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const blob = await res.blob();
                if (activeBlobUrl) URL.revokeObjectURL(activeBlobUrl);
                activeBlobUrl = URL.createObjectURL(blob);
                img.src = activeBlobUrl;
                lightbox.style.display = 'flex';
                
                const close = () => { lightbox.style.display = 'none'; img.src = ''; };
                lightbox.querySelector('.close-btn').onclick = close;
                lightbox.onclick = (e) => { if(e.target === lightbox) close(); };
            } catch (err) { console.error("Lightbox Error:", err); }
        }

        async function handleUpload(files) {
            const token = sessionStorage.getItem('jwt_token');
            const formData = new FormData();
            const status = document.getElementById('uploadStatus');
            Array.from(files).forEach(file => {
                formData.append('filenames[]', file.name);
                formData.append('files', file);
            });
            status.innerText = "Uploading...";
            try {
                await fetch(`${API_PATH}/upload`, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${token}` }, 
                    body: formData 
                });
                fetchPhotos(1); 
                updateStats();
            } catch (err) { alert("Upload failed"); }
            finally { status.innerText = "Click to Upload Photos"; }
        }

        async function deletePhoto(id) {
            if (!confirm("Delete this photo?")) return;
            const token = sessionStorage.getItem('jwt_token');
            try {
                await fetch(`${API_PATH}/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                fetchPhotos(currentPage); 
                updateStats();
            } catch (err) { alert("Delete failed"); }
        }

        async function downloadPhoto(id, name) {
            const token = sessionStorage.getItem('jwt_token');
            try {
                const res = await fetch(`${API_PATH}/download/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = name; a.click();
                window.URL.revokeObjectURL(url);
            } catch (err) { console.error("Download Error:", err); }
        }
    </script>
</body>
</html>