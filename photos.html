<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Hub - Instant Gallery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f0f2f5; --bg-card: #ffffff; --text-main: #1c1e21;
            --accent: #1877f2; --danger: #fa383e; --muted: #65676b;
            --sidebar-width: 240px;
        }
        body { background: var(--bg-page); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width); background: white; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
        }
        .sidebar h3 { font-size: 0.9rem; color: var(--muted); text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; }
        .album-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .album-item { 
            padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--text-main); 
            display: flex; align-items: center; gap: 10px; transition: 0.2s; margin-bottom: 4px;
        }
        .album-item:hover { background: #f0f2f5; }
        .album-item.active { background: #e7f3ff; color: var(--accent); font-weight: bold; }
        .album-item i { width: 16px; text-align: center; }

        /* Main Content Area */
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px;
        }
        .stat-card i { font-size: 1.5rem; color: var(--accent); }
        .stat-value { font-size: 1.2rem; font-weight: bold; display: block; }
        .stat-label { color: var(--muted); font-size: 0.75rem; text-transform: uppercase; }

        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .toolbar { display: flex; gap: 10px; background: white; padding: 8px; border-radius: 8px; align-items: center; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 10px; color: var(--muted); }
        .search-box input { padding: 8px 10px 8px 30px; border: 1px solid #ddd; border-radius: 6px; width: 200px; }

        /* Gallery Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .photo-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: 0.2s; display: flex; flex-direction: column; }
        .photo-card:hover { transform: translateY(-5px); }
        .photo-preview { width: 100%; height: 180px; object-fit: cover; cursor: zoom-in; background: #e4e6eb; }
        
        .photo-info { padding: 12px; flex-grow: 1; }
        .photo-name { font-weight: bold; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 8px; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .tag-pill { background: #f0f2f5; color: var(--muted); font-size: 0.65rem; padding: 2px 6px; border-radius: 6px; display: flex; align-items: center; gap: 4px; }
        .btn-add-tag { font-size: 0.65rem; color: var(--accent); cursor: pointer; border: 1px dashed var(--accent); padding: 1px 6px; border-radius: 6px; }

        .photo-actions { display: flex; justify-content: space-around; padding: 8px; background: #fafafa; border-top: 1px solid #eee; }
        .btn-action { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 1rem; }
        .btn-action:hover { color: var(--accent); }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        #lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .close-btn { position: absolute; top: 20px; right: 30px; color: white; font-size: 2rem; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2><i class="fas fa-th"></i> Photo Hub</h2>
        <br>
        <h3>Albums</h3>
        <ul class="album-list" id="albumSidebarList">
            <li class="album-item active" onclick="filterByTag(null, this)">
                <i class="fas fa-layer-group"></i> All Photos
            </li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="stats-container">
            <div class="stat-card">
                <i class="fas fa-images"></i>
                <div><span class="stat-value" id="stat-count">0</span><span class="stat-label">Photos</span></div>
            </div>
            <div class="stat-card">
                <i class="fas fa-folder-open"></i>
                <div><span class="stat-value" id="stat-albums">0</span><span class="stat-label">Albums</span></div>
            </div>
            <div class="stat-card">
                <i class="fas fa-hdd"></i>
                <div><span class="stat-value" id="stat-size">0.00 MB</span><span class="stat-label">Used</span></div>
            </div>
        </div>

        <div class="header-nav">
            <div class="toolbar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search filenames..." oninput="debouncedSearch()">
                </div>
                <select id="sortSelect" onchange="fetchPhotos(1)" style="padding: 6px; border-radius: 6px; border: 1px solid #ddd;">
                    <option value="updatedAt">Newest</option>
                    <option value="sizeBytes">Size</option>
                    <option value="cleanName">Name</option>
                </select>
                <button onclick="document.getElementById('fileInput').click()" class="btn-action" title="Upload"><i class="fas fa-upload"></i></button>
                <input type="file" id="fileInput" multiple accept="image/*" onchange="handleUpload(this.files)">
            </div>
        </div>

        <div id="photoGallery" class="gallery-grid"></div>
    </main>

    <div id="lightbox">
        <span class="close-btn">&times;</span>
        <img id="lightboxImg">
    </div>

    <script>
        let API_PATH = ""; 
        let currentPage = 1;
        let searchTimeout = null;
        let activeBlobUrl = null;
        let selectedTags = [];

        window.onload = async () => {
            const configLoaded = await loadConfig();
            if (configLoaded) {
                fetchPhotos(1);
                updateStats();
            }
        };

        /**
         * Loads configuration from config.json
         * Map "api_host" from the JSON to the internal API_PATH
         */
        async function loadConfig() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error("config.json not found");
                
                const config = await response.json();
                
                // Use api_host as requested
                const host = config.api_host || "http://localhost:3001";
                API_PATH = `${host}/api/app/images`;
                
                console.log("Config loaded. API set to:", API_PATH);
                return true;
            } catch (err) {
                console.error("Config Load Error:", err);
                document.getElementById('photoGallery').innerHTML = 
                    `<p style="color:red; padding:20px;">Configuration Error: ${err.message}</p>`;
                return false;
            }
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchPhotos(1), 400);
        }

        async function updateStats() {
            if (!API_PATH) return;
            const token = sessionStorage.getItem('jwt_token');
            const headers = { 'Authorization': `Bearer ${token}` };
            try {
                const statsRes = await fetch(`${API_PATH}/stats`, { headers });
                const statsResult = await statsRes.json();
                if (statsResult.success && statsResult.summary) {
                    document.getElementById('stat-count').innerText = statsResult.summary.totalFiles;
                    document.getElementById('stat-size').innerText = statsResult.summary.totalSizeMB + ' MB';
                }

                const tagsRes = await fetch(`${API_PATH}/tags`, { headers });
                const tagsResult = await tagsRes.json();
                if (tagsResult.success) {
                    renderAlbumSidebar(tagsResult.data);
                    document.getElementById('stat-albums').innerText = tagsResult.data.length;
                }
            } catch (err) { console.error("Stats Error:", err); }
        }

        function renderAlbumSidebar(tags) {
            const list = document.getElementById('albumSidebarList');
            const allPhotosItem = `
                <li class="album-item ${selectedTags.length === 0 ? 'active' : ''}" onclick="filterByTag(null, this)">
                    <i class="fas fa-layer-group"></i> All Photos
                </li>`;
            
            const tagItems = tags.map(tag => `
                <li class="album-item ${selectedTags.includes(tag) ? 'active' : ''}" onclick="filterByTag('${tag}', this)">
                    <i class="fas fa-folder"></i> ${tag}
                </li>
            `).join('');
            
            list.innerHTML = allPhotosItem + tagItems;
        }

        function filterByTag(tag, element) {
            if (tag === null) {
                selectedTags = [];
            } else {
                const index = selectedTags.indexOf(tag);
                if (index > -1) selectedTags.splice(index, 1);
                else selectedTags.push(tag);
            }
            updateStats(); 
            fetchPhotos(1);
        }

        async function fetchPhotos(page = 1) {
            if (!API_PATH) return;
            currentPage = page;
            const container = document.getElementById('photoGallery');
            const token = sessionStorage.getItem('jwt_token');
            const sortBy = document.getElementById('sortSelect').value;
            const search = document.getElementById('searchInput').value;
            
            let url = `${API_PATH}/list?page=${page}&limit=20&sortBy=${sortBy}&cleanName=${search}`;
            if (selectedTags.length > 0) {
                url += `&tags=${selectedTags.join(',')}`;
            }

            try {
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const result = await res.json();
                const photos = result.data || [];
                container.innerHTML = photos.length ? "" : "<p style='color:var(--muted)'>No photos found.</p>";

                photos.forEach(photo => {
                    const id = photo._id || photo.id;
                    let thumbUrl = photo.thumbnailData || '';
                    if (thumbUrl && !thumbUrl.startsWith('data:')) thumbUrl = `data:image/webp;base64,${thumbUrl}`;

                    const tags = photo.tag_list || [];
                    const tagHtml = tags.map(tag => `
                        <span class="tag-pill"><i class="fas fa-folder"></i> ${tag} 
                        <i class="fas fa-times" style="cursor:pointer" onclick="updateTag('${id}', 'remove', '${tag}')"></i></span>
                    `).join('');

                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.innerHTML = `
                        <img src="${thumbUrl}" class="photo-preview" onclick="openLightbox('${id}')" onerror="this.src='https://via.placeholder.com/200'">
                        <div class="photo-info">
                            <div class="photo-name">${photo.cleanName}</div>
                            <div class="tag-container">${tagHtml}<span class="btn-add-tag" onclick="promptAddTag('${id}')">+ Album</span></div>
                        </div>
                        <div class="photo-actions">
                            <button class="btn-action" onclick="downloadPhoto('${id}', '${photo.cleanName}')"><i class="fas fa-download"></i></button>
                            <button class="btn-action" onclick="deletePhoto('${id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) { container.innerHTML = "Error loading gallery."; }
        }

        async function updateTag(id, action, tag) {
            if (!API_PATH) return;
            const token = sessionStorage.getItem('jwt_token');
            await fetch(`${API_PATH}/${id}/tags`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, tag })
            });
            fetchPhotos(currentPage);
            updateStats();
        }

        function promptAddTag(id) {
            const tag = prompt("Add to album:");
            if (tag && tag.trim()) updateTag(id, 'add', tag.trim());
        }

        async function openLightbox(id) {
            if (!API_PATH) return;
            const token = sessionStorage.getItem('jwt_token');
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            const res = await fetch(`${API_PATH}/download/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const blob = await res.blob();
            if (activeBlobUrl) URL.revokeObjectURL(activeBlobUrl);
            activeBlobUrl = URL.createObjectURL(blob);
            img.src = activeBlobUrl;
            lightbox.style.display = 'flex';
            lightbox.onclick = () => { lightbox.style.display = 'none'; URL.revokeObjectURL(activeBlobUrl); };
        }

        async function handleUpload(files) {
            if (!API_PATH) return;
            const token = sessionStorage.getItem('jwt_token');
            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('filenames[]', file.name);
                formData.append('files', file);
            });
            await fetch(`${API_PATH}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
            fetchPhotos(1); updateStats();
        }

        async function deletePhoto(id) {
            if (!API_PATH || !confirm("Delete photo?")) return;
            const token = sessionStorage.getItem('jwt_token');
            await fetch(`${API_PATH}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            fetchPhotos(currentPage); updateStats();
        }

        async function downloadPhoto(id, name) {
            if (!API_PATH) return;
            const token = sessionStorage.getItem('jwt_token');
            const res = await fetch(`${API_PATH}/download/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = name; a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>