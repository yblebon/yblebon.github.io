<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - Bulk Upload & Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f4f7f6; --bg-card: #ffffff; --text-main: #2d3436;
            --accent: #0984e3; --success: #00b894; --danger: #d63031; --muted: #636e72;
        }
        body { padding: 30px; background: var(--bg-page); font-family: 'Segoe UI', sans-serif; color: var(--text-main); }
        
        .upload-container {
            background: var(--bg-card); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;
            border: 2px dashed #b2bec3; cursor: pointer; margin-bottom: 20px;
        }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px; }

        .queue-item, .file-list-item {
            background: #fff; padding: 12px; border-radius: 8px; margin-top: 10px;
            display: grid; grid-template-columns: 40px 1fr 120px 150px; gap: 15px; align-items: center;
            border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .bulk-actions {
            margin-top: 20px; display: none; padding: 20px;
            background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-refresh { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .btn-refresh:hover { background: var(--accent); color: white; }

        .progress-track { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }
        
        .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: var(--muted); }
        .badge-encrypted { background: #e3f2fd; color: var(--accent); border: 1px solid var(--accent); }

        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; padding: 10px; }
        .btn-nav { padding: 5px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        .action-btns { display: flex; gap: 10px; justify-content: flex-end; }
        .action-btns button { border: none; background: none; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s; }
        .action-btns button:hover { transform: scale(1.2); }
        .btn-dl { color: var(--accent); }
        .btn-del { color: var(--danger); }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <h2><i class="fas fa-layer-group"></i> Bulk Upload & Manager</h2>

    <div class="upload-container" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--accent);"></i>
        <h3>Add Files to Queue</h3>
        <input type="file" id="fileInput" multiple onchange="addToQueue(this.files)">
    </div>

    <div id="fileQueue"></div>

    <div class="bulk-actions" id="bulkActions">
        <button class="btn-primary" onclick="uploadEverything()">
            <i class="fas fa-cloud-upload-alt"></i> Upload All Files
        </button>
        <div class="progress-track" id="globalProgressTrack">
            <div class="progress-bar" id="globalProgressBar"></div>
        </div>
    </div>

    <hr style="margin-top: 40px; border: 0; border-top: 1px solid #ddd;">

    <div class="section-header">
        <h3><i class="fas fa-list"></i> Remote File List</h3>
        <button class="btn-refresh" onclick="fetchFileList(currentPage)"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <div id="remoteFileList">
        <div style="text-align:center; padding: 20px; color: var(--muted);">Loading files...</div>
    </div>

    <div class="pagination-controls" id="paginationControls"></div>

    <script>
        let BASE_URL = "http://localhost:3001"; 
        let uploadQueue = []; 
        let currentPage = 1;

        window.onload = () => fetchFileList(1);

        // --- FETCH & RENDER LIST ---
        async function fetchFileList(page = 1) {
            currentPage = page;
            const listContainer = document.getElementById('remoteFileList');
            const paginationContainer = document.getElementById('paginationControls');
            const token = sessionStorage.getItem('jwt_token');

            try {
                const response = await fetch(`${BASE_URL}/api/app/files/list?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch");

                const result = await response.json();
                const files = result.data || [];
                const nav = result.pagination || {};

                listContainer.innerHTML = "";

                if (files.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted);">No files found on server.</div>';
                    paginationContainer.innerHTML = "";
                    return;
                }

                files.forEach(file => {
                    const fileId = file._id || file.id;
                    const item = document.createElement('div');
                    item.className = 'file-list-item';
                    const isEnc = file.isEncrypted ? '<span class="badge badge-encrypted"><i class="fas fa-lock"></i> Encrypted</span>' : '<span class="badge">Plain</span>';
                    
                    item.innerHTML = `
                        <i class="fas fa-file-alt" style="color:var(--muted)"></i>
                        <div>
                            <div style="font-weight:bold">${file.customName || file.originalName}</div>
                            <div style="font-size:0.75rem; color:var(--muted)">${file.hash ? file.hash.substring(0,12) : '---'}</div>
                        </div>
                        <div>${isEnc}</div>
                        <div class="action-btns">
                            <span style="font-size:0.85rem; margin-right:10px;">${(file.size / 1024).toFixed(1)} KB</span>
                            <button class="btn-dl" title="Download" onclick="downloadFile('${fileId}', '${file.customName || file.originalName}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-del" title="Delete" onclick="deleteFile('${fileId}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });

                renderPagination(nav);
            } catch (err) {
                listContainer.innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">Error loading file list.</div>';
            }
        }

        function renderPagination(nav) {
            const container = document.getElementById('paginationControls');
            if (!nav.totalPages || nav.totalPages <= 1) {
                container.innerHTML = "";
                return;
            }
            container.innerHTML = `
                <button class="btn-nav" ${nav.currentPage === 1 ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage - 1})">Prev</button>
                <span>Page ${nav.currentPage} of ${nav.totalPages}</span>
                <button class="btn-nav" ${nav.currentPage === nav.totalPages ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage + 1})">Next</button>
            `;
        }

        // --- DOWNLOAD OPERATION ---
        async function downloadFile(fileId, fileName) {
            const token = sessionStorage.getItem('jwt_token');
            try {
                const response = await fetch(`${BASE_URL}/api/app/files/download/${fileId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error("Download error");
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (err) {
                alert("Failed to download file.");
            }
        }

        // --- DELETE OPERATION ---
        async function deleteFile(fileId) {
            if (!confirm("Permanently delete this file?")) return;
            const token = sessionStorage.getItem('jwt_token');
            try {
                const response = await fetch(`${BASE_URL}/api/app/files/${fileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    fetchFileList(currentPage);
                } else {
                    alert("Delete failed.");
                }
            } catch (err) {
                alert("An error occurred.");
            }
        }

        // --- UPLOAD LOGIC ---
        function addToQueue(files) {
            const queueList = document.getElementById('fileQueue');
            Array.from(files).forEach(file => {
                const fileId = Date.now() + Math.random();
                uploadQueue.push({ id: fileId, file: file });
                const item = document.createElement('div');
                item.className = 'queue-item';
                item.id = `item-${fileId}`;
                item.innerHTML = `
                    <i class="fas fa-file"></i>
                    <input type="text" value="${file.name}" id="name-${fileId}" style="padding:5px; border:1px solid #ddd;">
                    <label><input type="checkbox" id="encrypt-${fileId}"> Encrypt</label>
                    <button style="color:var(--danger); border:none; background:none; cursor:pointer;" onclick="removeItem(${fileId})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                queueList.appendChild(item);
            });
            if (uploadQueue.length > 0) document.getElementById('bulkActions').style.display = 'block';
        }

        function removeItem(id) {
            uploadQueue = uploadQueue.filter(i => i.id !== id);
            document.getElementById(`item-${id}`).remove();
            if (uploadQueue.length === 0) document.getElementById('bulkActions').style.display = 'none';
        }

        async function uploadEverything() {
            const formData = new FormData();
            const token = sessionStorage.getItem('jwt_token');
            
            uploadQueue.forEach(item => {
                formData.append('filenames[]', document.getElementById(`name-${item.id}`).value);
                formData.append('encryptFlags[]', document.getElementById(`encrypt-${item.id}`).checked);
                formData.append('files', item.file);
            });

            const bar = document.getElementById('globalProgressBar');
            document.getElementById('globalProgressTrack').style.display = 'block';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${BASE_URL}/api/app/files/upload`, true);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) bar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
            };
            xhr.onload = () => {
                if (xhr.status === 200 || xhr.status === 201) {
                    alert("Upload successful!");
                    fetchFileList(1);
                    document.getElementById('fileQueue').innerHTML = "";
                    document.getElementById('bulkActions').style.display = 'none';
                    uploadQueue = [];
                } else { alert("Upload failed."); }
                document.getElementById('globalProgressTrack').style.display = 'none';
                bar.style.width = '0%';
            };
            xhr.send(formData);
        }
    </script>
</body>
</html>