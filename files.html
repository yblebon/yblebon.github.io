<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - Bulk Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f4f7f6; --bg-card: #ffffff; --text-main: #2d3436;
            --accent: #0984e3; --success: #00b894; --danger: #d63031; --muted: #636e72;
        }
        body { padding: 30px; background: var(--bg-page); font-family: 'Segoe UI', sans-serif; color: var(--text-main); }
        
        .upload-container {
            background: var(--bg-card); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;
            border: 2px dashed #b2bec3; cursor: pointer; margin-bottom: 20px;
        }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px; }

        .queue-item, .file-list-item {
            background: #fff; padding: 12px; border-radius: 8px; margin-top: 10px;
            display: grid; grid-template-columns: 40px 1fr 120px 40px; gap: 15px; align-items: center;
            border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .file-list-item { grid-template-columns: 40px 1fr 100px 120px; }

        .bulk-actions {
            margin-top: 20px; display: none; padding: 20px;
            background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-refresh { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .btn-refresh:hover { background: var(--accent); color: white; }

        .progress-track { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }
        
        .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: var(--muted); }
        .badge-encrypted { background: #e3f2fd; color: var(--accent); border: 1px solid var(--accent); }

        /* Pagination Styles */
        .pagination-controls { 
            display: flex; justify-content: center; align-items: center; 
            gap: 15px; margin-top: 20px; padding: 10px; 
        }
        .btn-nav { 
            padding: 5px 15px; border: 1px solid #ddd; background: white; 
            border-radius: 4px; cursor: pointer; 
        }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <h2><i class="fas fa-layer-group"></i> Single-Submit Bulk Upload</h2>

    <div class="upload-container" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--accent);"></i>
        <h3>Add Files to Queue</h3>
        <input type="file" id="fileInput" multiple onchange="addToQueue(this.files)">
    </div>

    <div id="fileQueue"></div>

    <div class="bulk-actions" id="bulkActions">
        <button class="btn-primary" onclick="uploadEverything()">
            <i class="fas fa-cloud-upload-alt"></i> Upload All in One Request
        </button>
        <div class="progress-track" id="globalProgressTrack">
            <div class="progress-bar" id="globalProgressBar"></div>
        </div>
    </div>

    <hr style="margin-top: 40px; border: 0; border-top: 1px solid #ddd;">

    <div class="section-header">
        <h3><i class="fas fa-list"></i> Remote File List</h3>
        <button class="btn-refresh" onclick="fetchFileList()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <div id="remoteFileList">
        <div style="text-align:center; padding: 20px; color: var(--muted);">Loading files...</div>
    </div>

    <div class="pagination-controls" id="paginationControls"></div>

    <script>
        let BASE_URL = "http://localhost:3001"; 
        let uploadQueue = []; 
        let currentPage = 1;

        window.onload = fetchFileList;

        async function fetchFileList(page = 1) {
            currentPage = page;
            const listContainer = document.getElementById('remoteFileList');
            const paginationContainer = document.getElementById('paginationControls');
            const token = sessionStorage.getItem('jwt_token');

            try {
                // Assuming your API accepts ?page= query parameter
                const response = await fetch(`${BASE_URL}/api/app/files/list?page=${page}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch");

                const result = await response.json();
                
                // DATA ACCESS UPDATE: Use result.data instead of data.files
                const files = result.data || [];
                const pagination = result.pagination || {};

                listContainer.innerHTML = "";

                if (files.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted);">No files found on server.</div>';
                    paginationContainer.innerHTML = "";
                    return;
                }

                files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-list-item';
                    const isEnc = file.isEncrypted ? '<span class="badge badge-encrypted"><i class="fas fa-lock"></i> Encrypted</span>' : '<span class="badge">Plain</span>';
                    
                    item.innerHTML = `
                        <i class="fas fa-file-alt" style="color:var(--muted)"></i>
                        <div>
                            <div style="font-weight:bold">${file.customName || file.originalName}</div>
                            <div style="font-size:0.75rem; color:var(--muted)">${file.hash ? file.hash.substring(0,16) : 'N/A'}...</div>
                        </div>
                        <div>${isEnc}</div>
                        <div style="font-size:0.85rem; text-align:right">${(file.size / 1024).toFixed(1)} KB</div>
                    `;
                    listContainer.appendChild(item);
                });

                renderPagination(pagination);

            } catch (err) {
                console.error("List Fetch Error:", err);
                listContainer.innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">Error loading file list.</div>';
            }
        }

        function renderPagination(nav) {
            const container = document.getElementById('paginationControls');
            if (!nav.totalPages || nav.totalPages <= 1) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = `
                <button class="btn-nav" ${nav.currentPage === 1 ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage - 1})">Prev</button>
                <span>Page ${nav.currentPage} of ${nav.totalPages}</span>
                <button class="btn-nav" ${nav.currentPage === nav.totalPages ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage + 1})">Next</button>
            `;
        }

        // --- Keep existing helper functions (addToQueue, removeItem, uploadEverything) ---
        function addToQueue(files) {
            const queueList = document.getElementById('fileQueue');
            const actions = document.getElementById('bulkActions');
            
            Array.from(files).forEach(file => {
                const fileId = Date.now() + Math.random();
                uploadQueue.push({ id: fileId, file: file });

                const item = document.createElement('div');
                item.className = 'queue-item';
                item.id = `item-${fileId}`;
                item.innerHTML = `
                    <i class="fas fa-file"></i>
                    <input type="text" value="${file.name}" id="name-${fileId}" style="width:90%; padding:5px; border:1px solid #ddd;">
                    <label style="font-size:0.85rem"><input type="checkbox" id="encrypt-${fileId}"> Encrypt</label>
                    <button style="color:var(--danger); border:none; background:none; cursor:pointer;" onclick="removeItem(${fileId})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                queueList.appendChild(item);
            });

            if (uploadQueue.length > 0) actions.style.display = 'block';
        }

        function removeItem(id) {
            uploadQueue = uploadQueue.filter(item => item.id !== id);
            document.getElementById(`item-${id}`).remove();
            if (uploadQueue.length === 0) document.getElementById('bulkActions').style.display = 'none';
        }

        async function uploadEverything() {
            const formData = new FormData();
            const endpoint = `${BASE_URL}/api/app/files/upload`;
            const token = sessionStorage.getItem('jwt_token');

            uploadQueue.forEach(item => {
                const customName = document.getElementById(`name-${item.id}`).value;
                const encrypt = document.getElementById(`encrypt-${item.id}`).checked;
                formData.append('filenames[]', customName);
                formData.append('encryptFlags[]', encrypt);
            });

            uploadQueue.forEach(item => {
                formData.append('files', item.file); 
            });

            const track = document.getElementById('globalProgressTrack');
            const bar = document.getElementById('globalProgressBar');
            track.style.display = 'block';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', endpoint, true);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    bar.style.width = pct + '%';
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 201) {
                    alert("Bulk upload successful!");
                    fetchFileList(1); 
                    document.getElementById('fileQueue').innerHTML = "";
                    document.getElementById('bulkActions').style.display = 'none';
                    uploadQueue = [];
                } else {
                    alert("Upload failed. Status: " + xhr.status);
                }
                track.style.display = 'none';
                bar.style.width = '0%';
            };

            xhr.send(formData);
        }
    </script>
</body>
</html>