<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - Bulk Upload & Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f4f7f6; --bg-card: #ffffff; --text-main: #2d3436;
            --accent: #0984e3; --success: #00b894; --danger: #d63031; --muted: #636e72;
        }
        body { padding: 30px; background: var(--bg-page); font-family: 'Segoe UI', sans-serif; color: var(--text-main); }
        
        /* Upload Section */
        .upload-container {
            background: var(--bg-card); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;
            border: 2px dashed #b2bec3; cursor: pointer; margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .upload-container:hover { border-color: var(--accent); }

        .queue-item, .file-list-item {
            background: #fff; padding: 12px; border-radius: 8px; margin-top: 10px;
            display: grid; grid-template-columns: 40px 1fr 120px 180px; gap: 15px; align-items: center;
            border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .bulk-actions {
            margin-top: 20px; display: none; padding: 20px;
            background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Buttons & Controls */
        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-refresh { background: none; border: 1px solid #ddd; color: var(--muted); padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-refresh:hover { color: var(--accent); border-color: var(--accent); }

        .progress-track { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }
        
        .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: var(--muted); }
        .badge-encrypted { background: #e3f2fd; color: var(--accent); border: 1px solid var(--accent); }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 15px; }

        /* Search & Filter Bar */
        .toolbar { display: flex; gap: 10px; align-items: center; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 10px; color: var(--muted); font-size: 0.8rem; }
        .search-box input { padding: 7px 10px 7px 30px; border-radius: 4px; border: 1px solid #ddd; width: 200px; }

        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px; padding: 10px; }
        .btn-nav { padding: 5px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .btn-nav:disabled { opacity: 0.5; cursor: not-allowed; }

        .action-btns { display: flex; gap: 8px; justify-content: flex-end; }
        .action-btns button { border: 1px solid #eee; background: #f9f9f9; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .action-btns button:hover { transform: translateY(-2px); background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-dl { color: var(--accent); }
        .btn-thumb { color: var(--success); font-size: 0.8rem !important; }
        .btn-del { color: var(--danger); }
        
        .file-icon { font-size: 1.4rem; text-align: center; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <h2><i class="fas fa-layer-group"></i> Bulk Upload & Manager</h2>

    <div class="upload-container" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-cloud-arrow-up" style="font-size: 2rem; color: var(--accent);"></i>
        <h3>Click to add files to queue</h3>
        <input type="file" id="fileInput" multiple onchange="addToQueue(this.files)">
    </div>

    <div id="fileQueue"></div>

    <div class="bulk-actions" id="bulkActions">
        <button class="btn-primary" onclick="uploadEverything()">
            <i class="fas fa-cloud-upload-alt"></i> Upload All Files
        </button>
        <div class="progress-track" id="globalProgressTrack">
            <div class="progress-bar" id="globalProgressBar"></div>
        </div>
    </div>

    <hr style="margin-top: 40px; border: 0; border-top: 1px solid #ddd;">

    <div class="section-header">
        <h3><i class="fas fa-list"></i> Remote File List</h3>
        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by name..." oninput="debouncedSearch()">
            </div>
            <select id="sortSelect" onchange="fetchFileList(1)" style="padding: 7px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="updatedAt">Sort by Date</option>
                <option value="sizeBytes">Sort by Size</option>
                <option value="cleanName">Sort by Name</option>
            </select>
            <button class="btn-refresh" onclick="fetchFileList(currentPage)" title="Refresh List">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div id="remoteFileList">
        <div style="text-align:center; padding: 20px; color: var(--muted);">Loading files...</div>
    </div>

    <div class="pagination-controls" id="paginationControls"></div>

    <script>
        let BASE_URL = ""; // Loaded from config.json
        let uploadQueue = []; 
        let currentPage = 1;
        let searchTimeout = null;

        // --- CONFIG LOADER ---
        async function loadConfig() {
            try {
                const res = await fetch('config.json');
                if (!res.ok) throw new Error("config.json not found");
                const config = await res.json();
                
                // Map api_host as requested
                BASE_URL = config.api_host || "http://localhost:3001";
                console.log("Config loaded. API Host:", BASE_URL);
                return true;
            } catch (err) {
                console.error("Config failed to load:", err);
                document.getElementById('remoteFileList').innerHTML = 
                    `<div style="color:var(--danger); text-align:center; padding:20px;">Configuration Error: Check config.json path.</div>`;
                return false;
            }
        }

        window.onload = async () => {
            const ok = await loadConfig();
            if (ok) fetchFileList(1);
        };

        // --- DEBOUNCED SEARCH ---
        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchFileList(1), 400);
        }

        // --- HELPER: GET ICON BY EXTENSION ---
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'fa-file-pdf', 'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel', 'txt': 'fa-file-lines',
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image',
                'webp': 'fa-file-image', 'zip': 'fa-file-zipper', 'rar': 'fa-file-zipper', 
                'js': 'fa-file-code', 'mp4': 'fa-file-video', 'mp3': 'fa-file-audio'
            };
            const iconClass = iconMap[ext] || 'fa-file';
            return `<i class="fas ${iconClass} file-icon" style="color: var(--muted)"></i>`;
        }

        // --- FETCH & RENDER LIST ---
        async function fetchFileList(page = 1) {
            if (!BASE_URL) return;
            currentPage = page;
            const listContainer = document.getElementById('remoteFileList');
            const paginationContainer = document.getElementById('paginationControls');
            const token = sessionStorage.getItem('jwt_token');
            
            const sortBy = document.getElementById('sortSelect').value;
            const cleanName = document.getElementById('searchInput').value;

            try {
                const params = new URLSearchParams({ page, limit: 10, sortBy, cleanName });
                const response = await fetch(`${BASE_URL}/api/app/files/list?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to fetch");

                const result = await response.json();
                const files = result.data || [];
                const nav = result.pagination || {};

                listContainer.innerHTML = "";

                if (files.length === 0) {
                    listContainer.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--muted);">No files found.</div>`;
                    paginationContainer.innerHTML = "";
                    return;
                }

                files.forEach(file => {
                    const fileId = file._id || file.id;
                    const updateDate = file.updatedAt ? new Date(file.updatedAt).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : '---';
                    const isEnc = file.isEncrypted ? '<span class="badge badge-encrypted"><i class="fas fa-lock"></i> Encrypted</span>' : '<span class="badge">Plain</span>';
                    const displayName = file.cleanName || file.originalName;

                    const item = document.createElement('div');
                    item.className = 'file-list-item';
                    item.innerHTML = `
                        ${getFileIcon(file.originalName)}
                        <div>
                            <div style="font-weight:bold">${displayName}</div>
                            <div style="font-size:0.75rem; color:var(--muted)">
                                Updated: ${updateDate} | ${(file.sizeBytes / 1024).toFixed(1)} KB
                            </div>
                        </div>
                        <div>${isEnc}</div>
                        <div class="action-btns">
                            <button class="btn-thumb" title="Download Thumbnail" onclick="downloadFile('${fileId}', '${displayName}', true)">
                                <i class="fas fa-image"></i> Thumb
                            </button>
                            <button class="btn-dl" title="Download Full File" onclick="downloadFile('${fileId}', '${displayName}', false)">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-del" title="Delete" onclick="deleteFile('${fileId}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });

                renderPagination(nav);
            } catch (err) {
                listContainer.innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">Error loading list. Check connection.</div>';
            }
        }

        function renderPagination(nav) {
            const container = document.getElementById('paginationControls');
            if (!nav.totalPages || nav.totalPages <= 1) { container.innerHTML = ""; return; }
            container.innerHTML = `
                <button class="btn-nav" ${nav.currentPage === 1 ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage - 1})">Prev</button>
                <span>Page ${nav.currentPage} of ${nav.totalPages}</span>
                <button class="btn-nav" ${nav.currentPage === nav.totalPages ? 'disabled' : ''} onclick="fetchFileList(${nav.currentPage + 1})">Next</button>
            `;
        }

        // --- DOWNLOAD HANDLER ---
        async function downloadFile(fileId, fallbackName, isThumbnail = false) {
            if (!BASE_URL) return;
            const token = sessionStorage.getItem('jwt_token');
            try {
                const url = `${BASE_URL}/api/app/files/download/${fileId}${isThumbnail ? '?thumbnail=true' : ''}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Download failed on server");

                const disposition = response.headers.get('Content-Disposition');
                let filename = isThumbnail ? `thumb-${fallbackName}` : fallbackName;
                
                if (disposition && disposition.includes('filename=')) {
                    filename = disposition.split('filename=')[1].split(';')[0].replace(/"/g, '');
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                window.URL.revokeObjectURL(downloadUrl);

            } catch (err) {
                console.error("Download Error:", err);
                alert("Download failed: " + err.message);
            }
        }

        // --- DELETE HANDLER ---
        async function deleteFile(fileId) {
            if (!BASE_URL || !confirm("Delete this file permanently?")) return;
            const token = sessionStorage.getItem('jwt_token');
            try {
                const response = await fetch(`${BASE_URL}/api/app/files/${fileId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) fetchFileList(currentPage);
                else alert("Delete failed.");
            } catch (err) { alert("Error deleting file."); }
        }

        // --- UPLOAD QUEUE LOGIC ---
        function addToQueue(files) {
            const queueList = document.getElementById('fileQueue');
            Array.from(files).forEach(file => {
                const fileId = Date.now() + Math.random();
                uploadQueue.push({ id: fileId, file: file });
                const item = document.createElement('div');
                item.className = 'queue-item';
                item.id = `item-${fileId}`;
                item.innerHTML = `
                    ${getFileIcon(file.name)}
                    <input type="text" value="${file.name}" id="name-${fileId}" style="padding:6px; border:1px solid #ddd; border-radius:4px; width: 90%;">
                    <label style="font-size: 0.85rem;"><input type="checkbox" id="encrypt-${fileId}"> Encrypt</label>
                    <button style="color:var(--danger); border:none; background:none; cursor:pointer;" onclick="removeItem(${fileId})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                queueList.appendChild(item);
            });
            if (uploadQueue.length > 0) document.getElementById('bulkActions').style.display = 'block';
        }

        function removeItem(id) {
            uploadQueue = uploadQueue.filter(i => i.id !== id);
            const el = document.getElementById(`item-${id}`);
            if(el) el.remove();
            if (uploadQueue.length === 0) document.getElementById('bulkActions').style.display = 'none';
        }

        // --- UPLOAD EXECUTION ---
        async function uploadEverything() {
            if (!BASE_URL) return;
            const formData = new FormData();
            const token = sessionStorage.getItem('jwt_token');
            
            uploadQueue.forEach(item => {
                formData.append('filenames[]', document.getElementById(`name-${item.id}`).value);
                formData.append('encryptFlags[]', document.getElementById(`encrypt-${item.id}`).checked);
            });
            uploadQueue.forEach(item => {
                formData.append('files', item.file);
            });

            const bar = document.getElementById('globalProgressBar');
            document.getElementById('globalProgressTrack').style.display = 'block';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', `${BASE_URL}/api/app/files/upload`, true);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    bar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200 || xhr.status === 201) {
                    alert("Bulk upload successful!");
                    fetchFileList(1);
                    document.getElementById('fileQueue').innerHTML = "";
                    document.getElementById('bulkActions').style.display = 'none';
                    uploadQueue = [];
                } else { 
                    alert("Upload failed. Check server limits."); 
                }
                document.getElementById('globalProgressTrack').style.display = 'none';
                bar.style.width = '0%';
            };

            xhr.onerror = () => alert("Network error during upload.");
            xhr.send(formData);
        }
    </script>
</body>
</html>