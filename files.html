<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - Bulk Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f4f7f6; --bg-card: #ffffff; --text-main: #2d3436;
            --accent: #0984e3; --success: #00b894; --danger: #d63031;
        }
        body { padding: 30px; background: var(--bg-page); font-family: 'Segoe UI', sans-serif; }
        
        .upload-container {
            background: var(--bg-card); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center;
            border: 2px dashed #b2bec3; cursor: pointer;
        }

        .queue-item {
            background: #fff; padding: 10px; border-radius: 8px; margin-top: 10px;
            display: grid; grid-template-columns: 50px 1fr 120px 40px; gap: 15px; align-items: center;
            border: 1px solid #ddd;
        }

        .bulk-actions {
            margin-top: 20px; display: none; padding: 20px;
            background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-primary { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .progress-track { width: 100%; height: 8px; background: #dfe6e9; border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }
        
        #fileInput { display: none; }
    </style>
</head>
<body>

    <h2><i class="fas fa-layer-group"></i> Single-Submit Bulk Upload</h2>

    <div class="upload-container" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--accent);"></i>
        <h3>Add Files to Queue</h3>
        <input type="file" id="fileInput" multiple onchange="addToQueue(this.files)">
    </div>

    <div id="fileQueue"></div>

    <div class="bulk-actions" id="bulkActions">
        <button class="btn-primary" onclick="uploadEverything()">
            <i class="fas fa-cloud-upload-alt"></i> Upload All in One Request
        </button>
        <div class="progress-track" id="globalProgressTrack">
            <div class="progress-bar" id="globalProgressBar"></div>
        </div>
    </div>

    <script>
        let BASE_URL = "http://localhost:3001"; // Default
        let uploadQueue = []; // Holds the actual File objects

        function addToQueue(files) {
            const queueList = document.getElementById('fileQueue');
            const actions = document.getElementById('bulkActions');
            
            Array.from(files).forEach(file => {
                const fileId = Date.now() + Math.random();
                uploadQueue.push({ id: fileId, file: file });

                const item = document.createElement('div');
                item.className = 'queue-item';
                item.id = `item-${fileId}`;
                item.innerHTML = `
                    <i class="fas fa-file"></i>
                    <input type="text" value="${file.name}" id="name-${fileId}" style="width:90%; padding:5px; border:1px solid #ddd;">
                    <label><input type="checkbox" id="encrypt-${fileId}"> Encrypt</label>
                    <button style="color:var(--danger); border:none; background:none; cursor:pointer;" onclick="removeItem(${fileId})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                queueList.appendChild(item);
            });

            if (uploadQueue.length > 0) actions.style.display = 'block';
        }

        function removeItem(id) {
            uploadQueue = uploadQueue.filter(item => item.id !== id);
            document.getElementById(`item-${id}`).remove();
            if (uploadQueue.length === 0) document.getElementById('bulkActions').style.display = 'none';
        }

        async function uploadEverything() {
            const formData = new FormData();
            const endpoint = `${BASE_URL}/api/app/files/upload`;
            
            console.group("ðŸš€ Bulk Upload Start");
            console.log("Target:", endpoint);

            // Add all files to the SAME formData object
            uploadQueue.forEach(item => {
                const customName = document.getElementById(`name-${item.id}`).value;
                const encrypt = document.getElementById(`encrypt-${item.id}`).checked;
                
                // Note: The key name 'files' (plural) is often expected by backends for arrays
                formData.append('files', item.file); 
                
                // Metadata arrays (optional, check if your backend supports parallel arrays)
                formData.append('filenames[]', customName);
                formData.append('encryptFlags[]', encrypt);
                
                console.log(`Adding to payload: ${customName} (Encrypt: ${encrypt})`);
            });
            console.groupEnd();

            const track = document.getElementById('globalProgressTrack');
            const bar = document.getElementById('globalProgressBar');
            track.style.display = 'block';

            const xhr = new XMLHttpRequest();
            xhr.open('POST', endpoint, true);
            xhr.setRequestHeader('Authorization', `Bearer ${sessionStorage.getItem('jwt_token')}`);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    bar.style.width = pct + '%';
                }
            };

            xhr.onload = function() {
                console.log("ðŸ“¦ Server Response:", xhr.status, xhr.responseText);
                if (xhr.status === 200 || xhr.status === 201) {
                    alert("Bulk upload successful!");
                    location.reload(); 
                } else {
                    alert("Upload failed. Status: " + xhr.status);
                }
            };

            xhr.send(formData);
        }
    </script>
</body>
</html>