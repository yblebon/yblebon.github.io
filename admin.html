<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60; 
            --danger: #e74c3c; --warning: #f39c12; --light: #ecf0f1; --muted: #95a5a6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--primary); }
        
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        main { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        
        /* Stats Bar */
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; padding: 0 20px; }
        .stat-card { background: white; padding: 15px 25px; border-radius: 8px; flex: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
        .stat-card i { font-size: 1.5rem; color: var(--accent); }
        .stat-val { font-size: 1.4rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; }

        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .scroll-area { flex: 1; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #fdfdfd; padding: 12px 20px; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 12px 20px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f1f7ff; cursor: pointer; }
        .active-row { background: #e1f0ff !important; border-left: 4px solid var(--accent); }

        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }
        .status-active { background: #d4edda; color: var(--success); }
        .status-inactive { background: #f8d7da; color: var(--danger); }
        
        .btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-reset { background: var(--warning); color: white; }
        .btn-toggle { background: var(--light); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* Custom Modal System */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <i class="fas fa-user-shield fa-2x"></i>
        <h1 style="margin:0; font-size: 1.4rem;">Admin Dashboard</h1>
    </div>
    <button class="btn" onclick="location.href='index.html'" style="background:rgba(255,255,255,0.1); color:white;">Exit Admin</button>
</header>

<div class="stats-bar">
    <div class="stat-card">
        <i class="fas fa-users"></i>
        <div><span class="stat-val" id="totalUsers">0</span><span class="stat-label">Total Users</span></div>
    </div>
    <div class="stat-card">
        <i class="fas fa-check-circle" style="color: var(--success);"></i>
        <div><span class="stat-val" id="activeUsers">0</span><span class="stat-label">Active</span></div>
    </div>
    <div class="stat-card">
        <i class="fas fa-history" style="color: var(--warning);"></i>
        <div><span class="stat-val" id="totalLogs">0</span><span class="stat-label">Actions Logged</span></div>
    </div>
</div>

<main>
    <section class="card">
        <div class="card-header">
            <h3>User Directory</h3>
            <button class="btn btn-toggle" onclick="fetchUsers()"><i class="fas fa-sync"></i> Refresh</button>
        </div>
        <div class="scroll-area">
            <table>
                <thead>
                    <tr><th>User</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="userListBody"></tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <div class="card-header"><h3>Recent Activity</h3></div>
        <div class="scroll-area" id="logsContainer">
            <div style="padding:40px; text-align:center; color:var(--muted);">Select a user to view logs</div>
        </div>
    </section>
</main>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle">Confirm Action</h3>
        <p id="confirmMessage"></p>
        <div class="modal-footer">
            <button class="btn btn-toggle" onclick="closeModals()">Cancel</button>
            <button id="confirmBtn" class="btn">Proceed</button>
        </div>
    </div>
</div>

<div id="resetModal" class="modal">
    <div class="modal-content">
        <h3>Reset Password</h3>
        <p id="resetTargetText" style="color:var(--muted); font-size:0.9rem;"></p>
        <input type="password" id="newPasswordInput" placeholder="New Password (min 8 chars)">
        <div class="modal-footer">
            <button class="btn btn-toggle" onclick="closeModals()">Cancel</button>
            <button class="btn btn-reset" onclick="submitPasswordReset()">Update Password</button>
        </div>
    </div>
</div>

<script>
    let API_BASE = "";
    const token = sessionStorage.getItem('jwt_token');
    let currentSelectedUserId = null;
    let pendingAction = null;

    async function init() {
        try {
            const res = await fetch('config.json');
            const config = await res.json();
            API_BASE = `${config.api_host || "http://localhost:3001"}/api/admin`;
            if (!token) { window.location.href = 'login.html'; return; }
            fetchUsers();
        } catch (e) { console.error("Config failed"); }
    }

    async function fetchUsers() {
        const res = await fetch(`${API_BASE}/users`, { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        if (result.success) {
            renderUsers(result.data);
            updateStats(result.data);
        }
    }

    function renderUsers(users) {
        const body = document.getElementById('userListBody');
        body.innerHTML = users.map(user => `
            <tr id="row-${user.id}" onclick="viewLogs(${user.id}, '${user.username}')">
                <td><strong>${user.username}</strong><br><small style="color:var(--muted)">ID: ${user.id}</small></td>
                <td><span class="status-pill ${user.is_active ? 'status-active' : 'status-inactive'}">${user.is_active ? 'ACTIVE' : 'LOCKED'}</span></td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-reset" onclick="openResetModal(${user.id}, '${user.username}')"><i class="fas fa-key"></i></button>
                    <button class="btn btn-toggle" onclick="askToggleStatus(${user.id}, ${user.is_active})">
                        <i class="fas ${user.is_active ? 'fa-user-slash' : 'fa-user-check'}"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function updateStats(users) {
        document.getElementById('totalUsers').innerText = users.length;
        document.getElementById('activeUsers').innerText = users.filter(u => u.is_active).length;
    }

    // --- MODAL & TOGGLE LOGIC ---
    function askToggleStatus(id, isActive) {
        const title = isActive ? 'Deactivate User?' : 'Activate User?';
        const msg = `Are you sure you want to ${isActive ? 'lock' : 'unlock'} account #${id}? The user will ${isActive ? 'lose' : 'regain'} access immediately.`;
        
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmMessage').innerText = msg;
        const btn = document.getElementById('confirmBtn');
        btn.className = isActive ? 'btn btn-danger' : 'btn btn-reset';
        btn.innerText = isActive ? 'Deactivate' : 'Activate';
        
        btn.onclick = () => performToggle(id, isActive);
        document.getElementById('confirmModal').style.display = 'flex';
    }

    async function performToggle(id, currentStatus) {
        closeModals();
        const res = await fetch(`${API_BASE}/toggle-status`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id, isActive: !currentStatus })
        });
        if (res.ok) fetchUsers();
    }

    function openResetModal(id, name) {
        currentSelectedUserId = id;
        document.getElementById('resetTargetText').innerText = `Setting new password for ${name}`;
        document.getElementById('resetModal').style.display = 'flex';
    }

    async function submitPasswordReset() {
        const pw = document.getElementById('newPasswordInput').value;
        if(pw.length < 8) return alert("Min 8 chars");
        
        const res = await fetch(`${API_BASE}/reset-password`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentSelectedUserId, newPassword: pw })
        });
        if (res.ok) { alert("Password updated"); closeModals(); }
    }

    async function viewLogs(id, name) {
        document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
        document.getElementById(`row-${id}`).classList.add('active-row');
        
        const res = await fetch(`${API_BASE}/logs/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const result = await res.json();
        const container = document.getElementById('logsContainer');
        
        container.innerHTML = `<div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">Logs: ${name}</div>`;
        container.innerHTML += result.data.map(log => `
            <div style="padding:12px; border-bottom:1px solid #f9f9f9; font-size:0.85rem;">
                <span style="color:var(--muted); font-size:0.7rem;">${new Date(log.created_at).toLocaleString()}</span><br>
                <strong>${log.action}</strong> <small>(${log.ip_address || 'no-ip'})</small>
            </div>
        `).join('');
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('newPasswordInput').value = '';
    }

    window.onclick = (e) => { if(e.target.className === 'modal') closeModals(); };
    window.onload = init;
</script>
</body>
</html>