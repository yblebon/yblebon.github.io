<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Hub | Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60; 
            --danger: #e74c3c; --warning: #f39c12; --light: #ecf0f1; --muted: #95a5a6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--primary); }
        
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-bar { background: white; display: flex; padding: 0 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 15px 25px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: var(--muted); transition: 0.3s; }
        .tab.active { border-color: var(--accent); color: var(--accent); background: #fcfcfc; }

        main { padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #fdfdfd; padding: 12px 20px; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 12px 20px; border-bottom: 1px solid #eee; font-size: 0.9rem; vertical-align: middle; }

        .btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 0.8rem; font-weight: 600; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-toggle { background: var(--light); color: var(--primary); }
        
        select, input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        select:focus { border-color: var(--accent); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <i class="fas fa-shield-alt fa-lg"></i>
        <h2 style="margin:0; font-weight: 500;">Admin Control Center</h2>
    </div>
    <button class="btn btn-toggle" onclick="location.href='index.html'">Return to Gallery</button>
</header>

<div class="tab-bar">
    <div class="tab active" onclick="switchTab('users')"><i class="fas fa-users-cog"></i> Users & Roles</div>
    <div class="tab" onclick="switchTab('apps')"><i class="fas fa-th-large"></i> App Permissions</div>
</div>

<main id="userTab">
    <div class="card">
        <div class="card-header">
            <h3>User Management</h3>
            <button class="btn btn-toggle" onclick="loadUserData()"><i class="fas fa-sync"></i> Refresh List</button>
        </div>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Security</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userListBody"></tbody>
            </table>
        </div>
    </div>
</main>

<main id="appTab" class="hidden">
    <div class="grid-2">
        <div class="card">
            <div class="card-header">
                <h3>App Registry</h3>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="newAppName" placeholder="app_name">
                    <button class="btn btn-primary" onclick="handleAddApp()">Add</button>
                </div>
            </div>
            <table id="appsTable">
                <thead><tr><th>Name</th><th>Created</th></tr></thead>
                <tbody id="appsListBody"></tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Access Matrix</h3>
                <button class="btn btn-primary" onclick="openAssignModal()">Grant Access</button>
            </div>
            <table id="permsTable">
                <thead><tr><th>Role</th><th>App</th><th>Action</th></tr></thead>
                <tbody id="permsListBody"></tbody>
            </table>
        </div>
    </div>
</main>

<div id="pwModal" class="modal">
    <div class="modal-content">
        <h3>Force Password Reset</h3>
        <p id="pwTarget" style="color:var(--muted);"></p>
        <input type="password" id="newPw" placeholder="New Password (min 8 chars)" style="width:100%; margin-bottom:15px;">
        <div style="display:flex; justify-content: flex-end; gap:10px;">
            <button class="btn btn-toggle" onclick="closeModals()">Cancel</button>
            <button class="btn btn-primary" onclick="submitReset()">Update Password</button>
        </div>
    </div>
</div>

<div id="assignModal" class="modal">
    <div class="modal-content">
        <h3>Assign Permission</h3>
        <div style="display:flex; flex-direction:column; gap:12px;">
            <label>Role</label><select id="roleSelect"></select>
            <label>App</label><select id="appSelect"></select>
        </div>
        <div style="display:flex; justify-content: flex-end; gap:10px; margin-top:20px;">
            <button class="btn btn-toggle" onclick="closeModals()">Cancel</button>
            <button class="btn btn-primary" onclick="submitPermission()">Grant Access</button>
        </div>
    </div>
</div>

<script>
    let API_BASE = "";
    const token = sessionStorage.getItem('jwt_token');
    let rolesData = []; // Store roles for dropdowns

    async function init() {
        const configRes = await fetch('config.json');
        const config = await configRes.json();
        API_BASE = `${config.api_host || "http://localhost:3001"}/api/admin`;
        
        if (!token) { window.location.href = 'login.html'; return; }
        
        await loadRoles();
        loadUserData();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.toLowerCase().includes(tab)));
        document.getElementById('userTab').classList.toggle('hidden', tab !== 'users');
        document.getElementById('appTab').classList.toggle('hidden', tab !== 'apps');
        if(tab === 'apps') loadAppData();
    }

    // --- SHARED DATA ---
    async function loadRoles() {
        const res = await fetch(`${API_BASE}/roles`, { headers: {'Authorization': `Bearer ${token}`}});
        const result = await res.json();
        if(result.success) rolesData = result.data;
    }

    // --- USER MANAGEMENT ---
    async function loadUserData() {
        const res = await fetch(`${API_BASE}/users`, { headers: {'Authorization': `Bearer ${token}`}});
        const result = await res.json();
        if(!result.success) return;

        const body = document.getElementById('userListBody');
        body.innerHTML = result.data.map(user => `
            <tr>
                <td><strong>${user.username}</strong><br><small style="color:var(--muted)">ID: ${user.id}</small></td>
                <td>
                    <select onchange="handleRoleChange(${user.id}, this.value)">
                        ${rolesData.map(r => `<option value="${r.role_name}" ${user.role_name === r.role_name ? 'selected' : ''}>${r.role_name}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <button class="btn ${user.is_active ? 'btn-toggle' : 'btn-danger'}" onclick="handleToggleStatus(${user.id}, ${user.is_active})">
                        ${user.is_active ? '<i class="fas fa-check"></i> Active' : '<i class="fas fa-lock"></i> Locked'}
                    </button>
                </td>
                <td><button class="btn btn-reset" onclick="openPwModal(${user.id}, '${user.username}')">Reset PW</button></td>
                <td><button class="btn btn-toggle" onclick="viewLogs(${user.id})"><i class="fas fa-history"></i> Logs</button></td>
            </tr>
        `).join('');
    }

    async function handleRoleChange(userId, roleName) {
        if(!confirm(`Change user role to ${roleName}?`)) return loadUserData();
        const res = await fetch(`${API_BASE}/users/role`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, roleName })
        });
        const result = await res.json();
        alert(result.message);
        loadUserData();
    }

    async function handleToggleStatus(userId, isActive) {
        if(!confirm(`Are you sure you want to ${isActive ? 'Deactivate' : 'Activate'} this user?`)) return;
        await fetch(`${API_BASE}/toggle-status`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, isActive: !isActive })
        });
        loadUserData();
    }

    // --- APP & PERMISSION MANAGEMENT ---
    async function loadAppData() {
        const [apps, perms] = await Promise.all([
            fetch(`${API_BASE}/apps`, { headers: {'Authorization': `Bearer ${token}`}}).then(r => r.json()),
            fetch(`${API_BASE}/permissions`, { headers: {'Authorization': `Bearer ${token}`}}).then(r => r.json())
        ]);

        document.getElementById('appsListBody').innerHTML = apps.data.map(a => `<tr><td>${a.app_name}</td><td>${new Date().toLocaleDateString()}</td></tr>`).join('');
        document.getElementById('permsListBody').innerHTML = perms.data.map(p => `
            <tr>
                <td><span style="font-weight:bold; color:var(--accent)">${p.role_name}</span></td>
                <td>${p.app_name}</td>
                <td><button class="btn btn-danger" onclick="revokePerm('${p.role_name}', '${p.app_name}')">Revoke</button></td>
            </tr>
        `).join('');
    }

    async function revokePerm(roleName, appName) {
        if(!confirm("Revoke access?")) return;
        await fetch(`${API_BASE}/permissions/revoke`, {
            method: 'DELETE',
            headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({ roleName, appName })
        });
        loadAppData();
    }

    // Modal Helpers
    let currentTargetId = null;
    function openPwModal(id, name) {
        currentTargetId = id;
        document.getElementById('pwTarget').innerText = `Target: ${name}`;
        document.getElementById('pwModal').style.display = 'flex';
    }

    async function submitReset() {
        const newPassword = document.getElementById('newPw').value;
        const res = await fetch(`${API_BASE}/reset-password`, {
            method: 'POST',
            headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: currentTargetId, newPassword })
        });
        if(res.ok) { alert("Updated successfully"); closeModals(); }
    }

    function openAssignModal() {
        document.getElementById('roleSelect').innerHTML = rolesData.map(r => `<option value="${r.role_name}">${r.role_name}</option>`).join('');
        // This would ideally be populated from app list
        document.getElementById('assignModal').style.display = 'flex';
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    window.onload = init;
</script>
</body>
</html>