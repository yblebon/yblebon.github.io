<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { padding: 30px; background: #fff; font-family: sans-serif; }
        .form-container { max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        
        .recorder-box { 
            background: #f8f9fa; padding: 20px; border-radius: 12px; 
            text-align: center; border: 2px dashed #dfe6e9; 
        }
        .btn-record { 
            background: #e74c3c; color: white; border: none; padding: 10px 20px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; margin-bottom: 10px;
        }
        .btn-record.recording { animation: pulse 1.5s infinite; background: #c0392b; }
        
        .btn-submit {
            background: #26a69a; color: white; border: none; padding: 15px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px;
        }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        .cover-preview { 
            width: 100%; height: 150px; background: #eee; 
            border-radius: 8px; object-fit: cover; display: none; margin-top: 10px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h2><i class="fas fa-microphone"></i> New Voice Note (Debug Mode)</h2>
    
    <div class="form-container">
        <div class="field-group">
            <label class="section-label">Title (name)</label>
            <input type="text" id="noteTitle" placeholder="Meeting_Note_20240101">
        </div>

        <div class="field-group">
            <label class="section-label">Description</label>
            <textarea id="noteDesc" rows="3" placeholder="Test upload with tags and cover"></textarea>
        </div>

        <div class="field-group">
            <label class="section-label">Tags (comma separated)</label>
            <input type="text" id="noteTags" placeholder="work,meeting,important">
        </div>

        <div class="field-group">
            <label class="section-label">Cover Image</label>
            <input type="file" id="coverUpload" accept="image/*" onchange="previewImage(event)">
            <img id="preview" class="cover-preview">
        </div>

        <div class="field-group">
            <label class="section-label">Audio Recording</label>
            <div class="recorder-box">
                <button id="recordBtn" class="btn-record">
                    <i class="fas fa-circle"></i> Start Recording
                </button>
                <div id="audioPlaybackContainer">
                    <audio id="audioPlayback" controls style="display:none; width: 100%; margin-top: 10px;"></audio>
                </div>
            </div>
        </div>

        <button id="saveBtn" class="btn-submit" onclick="saveNote()">Upload to Server</button>
        <div id="statusMsg" style="margin-top: 10px; font-size: 0.9rem; text-align: center;"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let finalAudioBlob = null;
        const recordBtn = document.getElementById('recordBtn');
        const audioPlayback = document.getElementById('audioPlayback');

        function previewImage(event) {
            console.log("üì∏ Image selected:", event.target.files[0]);
            const preview = document.getElementById('preview');
            preview.src = URL.createObjectURL(event.target.files[0]);
            preview.style.display = 'block';
        }

        recordBtn.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    console.log("üé§ Requesting microphone access...");
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                        console.log("üì¶ Audio chunk received:", e.data.size, "bytes");
                    };

                    mediaRecorder.onstop = () => {
                        finalAudioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                        console.log("üíæ Recording stopped. Total Blob size:", finalAudioBlob.size, "bytes");
                        audioPlayback.src = URL.createObjectURL(finalAudioBlob);
                        audioPlayback.style.display = 'block';
                    };

                    mediaRecorder.start();
                    console.log("‚è∫ Recording started...");
                    recordBtn.classList.add('recording');
                    recordBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                } catch (err) { 
                    console.error("‚ùå MediaRecorder Error:", err);
                    alert("Microphone access denied."); 
                }
            } else {
                mediaRecorder.stop();
                recordBtn.classList.remove('recording');
                recordBtn.innerHTML = '<i class="fas fa-circle"></i> Start Recording';
            }
        });

        async function saveNote() {
            const saveBtn = document.getElementById('saveBtn');
            const statusMsg = document.getElementById('statusMsg');
            
            const name = document.getElementById('noteTitle').value;
            const description = document.getElementById('noteDesc').value;
            const tags = document.getElementById('noteTags').value;
            const coverFile = document.getElementById('coverUpload').files[0];

            console.group("üöÄ Preparing Upload");
            
            if (!name || !finalAudioBlob) {
                console.warn("‚ö†Ô∏è Validation failed: Missing name or audio blob");
                statusMsg.style.color = "red";
                statusMsg.innerText = "Name and Audio recording are required.";
                console.groupEnd();
                return;
            }

            const formData = new FormData();
            formData.append('audio', finalAudioBlob, `recording_${Date.now()}.mp3`);
            if (coverFile) formData.append('cover', coverFile);
            formData.append('name', name);
            formData.append('description', description);
            formData.append('tags', tags);

            // Log FormData Contents (Since FormData is opaque)
            for (let [key, value] of formData.entries()) {
                console.log(`üîπ FormData Key: ${key} | Value:`, value);
            }

            saveBtn.disabled = true;
            saveBtn.innerText = "Uploading...";

            try {
                const token = sessionStorage.getItem('jwt_token');
                const baseUrl = "https://app-blue-kappa.vercel.app"; 
                const appName = "voice-notes"; 
                const uploadUrl = `${baseUrl}/api/app/${appName}/upload?encrypt=false`;

                console.log("üåê URL:", uploadUrl);
                console.log("üîë Auth Token:", token ? "Found (Truncated: " + token.substring(0, 10) + "...)" : "Not Found!");

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Note: Browser automatically sets multipart/form-data boundary
                    },
                    body: formData
                });

                console.group("üì° Server Response");
                console.log("Status Code:", response.status);
                console.log("Status Text:", response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    console.log("‚úÖ Success Data:", result);
                    statusMsg.style.color = "green";
                    statusMsg.innerText = "Upload successful!";
                } else {
                    const errText = await response.text();
                    console.error("‚ùå Server Error Payload:", errText);
                    throw new Error(`Server returned ${response.status}: ${errText}`);
                }
                console.groupEnd();

            } catch (error) {
                console.error("üî• Network/Fetch Error:", error);
                statusMsg.style.color = "red";
                statusMsg.innerText = "Upload failed: " + error.message;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "Upload to Server";
                console.groupEnd();
            }
        }
    </script>
</body>
</html>