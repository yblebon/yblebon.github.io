<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Change Password</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-page: #f0f2f5; --bg-card: #ffffff; --text-main: #1c1e21;
            --accent: #1877f2; --danger: #fa383e; --success: #42b72a; --warning: #f7b731; --muted: #65676b;
        }
        body { background: var(--bg-page); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        .profile-container {
            background: var(--bg-card); padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
        }
        
        h2 { margin-bottom: 20px; color: var(--text-main); font-size: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--muted); font-size: 0.9rem; }
        
        /* Password container for the eye icon */
        .password-input-wrapper { position: relative; display: flex; align-items: center; }
        .password-input-wrapper input { padding-right: 40px; }
        .toggle-password {
            position: absolute; right: 12px; cursor: pointer; color: var(--muted);
            transition: color 0.2s; z-index: 10;
        }
        .toggle-password:hover { color: var(--accent); }

        input { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; 
            box-sizing: border-box; font-size: 1rem;
        }
        input:focus { border-color: var(--accent); outline: none; }

        .strength-wrapper { margin-top: 8px; margin-bottom: 15px; }
        .strength-bar-container { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-bottom: 4px; }
        .strength-bar { height: 100%; width: 0%; transition: all 0.3s ease; }
        #strengthText { font-size: 0.75rem; font-weight: bold; color: var(--muted); }

        .btn-update {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
            font-size: 1rem; margin-top: 10px; transition: background 0.2s;
        }
        .btn-update:hover { background: #166fe5; }
        .btn-update:disabled { background: #ccc; cursor: not-allowed; }

        .alert { padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.85rem; display: none; }
        .alert-error { background: #ffebe9; color: var(--danger); border: 1px solid var(--danger); }
        .alert-success { background: #e7f3ff; color: var(--accent); border: 1px solid var(--accent); }

        .back-nav { display: block; text-align: center; margin-top: 20px; text-decoration: none; color: var(--muted); font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="profile-container">
        <h2><i class="fas fa-lock"></i> Password Security</h2>
        
        <div id="alertBox" class="alert"></div>

        <form id="changePasswordForm">
            <div class="form-group">
                <label>Current Password</label>
                <div class="password-input-wrapper">
                    <input type="password" id="currentPassword" required>
                    <i class="fas fa-eye toggle-password" onclick="toggleVisibility('currentPassword', this)"></i>
                </div>
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

            <div class="form-group">
                <label>New Password</label>
                <div class="password-input-wrapper">
                    <input type="password" id="newPassword" required oninput="checkStrength(this.value)">
                    <i class="fas fa-eye toggle-password" onclick="toggleVisibility('newPassword', this)"></i>
                </div>
                
                <div class="strength-wrapper">
                    <div class="strength-bar-container">
                        <div id="strengthBar" class="strength-bar"></div>
                    </div>
                    <span id="strengthText">Strength: Too Short</span>
                </div>
            </div>

            <div class="form-group">
                <label>Confirm New Password</label>
                <div class="password-input-wrapper">
                    <input type="password" id="confirmPassword" required>
                    <i class="fas fa-eye toggle-password" onclick="toggleVisibility('confirmPassword', this)"></i>
                </div>
            </div>

            <button type="submit" class="btn-update" id="submitBtn">Update Password</button>
        </form>

        <a href="index.html" class="back-nav"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <script>
        let CHANGE_PW_URL = "";

        async function initConfig() {
            try {
                const response = await fetch('config.json');
                const config = await response.json();
                CHANGE_PW_URL = `${config.api_host || "http://localhost:3001"}/api/auth/change-password`;
            } catch (err) { showAlert("Error loading config.", "error"); }
        }

        // --- NEW: TOGGLE VISIBILITY ---
        function toggleVisibility(inputId, iconEl) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                iconEl.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = "password";
                iconEl.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function checkStrength(pw) {
            const bar = document.getElementById('strengthBar');
            const text = document.getElementById('strengthText');
            let score = 0;

            if (!pw) {
                bar.style.width = '0%';
                text.innerText = 'Strength: Empty';
                return;
            }

            if (pw.length >= 8) score++;
            if (/[0-9]/.test(pw)) score++;
            if (/[A-Z]/.test(pw)) score++;
            if (/[^A-Za-z0-9]/.test(pw)) score++;

            const states = [
                { color: '#fa383e', width: '25%', label: 'Weak' },
                { color: '#f7b731', width: '50%', label: 'Fair' },
                { color: '#1877f2', width: '75%', label: 'Good' },
                { color: '#42b72a', width: '100%', label: 'Strong' }
            ];

            const state = states[score - 1] || { color: '#eee', width: '10%', label: 'Too Short' };
            
            bar.style.width = state.width;
            bar.style.backgroundColor = state.color;
            text.innerText = `Strength: ${state.label}`;
            text.style.color = state.color;
        }

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.innerText = msg; box.style.display = 'block';
            box.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
        }

        document.getElementById('changePasswordForm').onsubmit = async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert("Passwords do not match.", "error");
                return;
            }

            const token = sessionStorage.getItem('jwt_token');
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            try {
                const res = await fetch(CHANGE_PW_URL, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const result = await res.json();
                if (res.ok) {
                    showAlert("Success!", "success");
                    e.target.reset();
                    checkStrength("");
                } else {
                    showAlert(result.message || "Error", "error");
                }
            } catch (err) {
                showAlert("Network Error", "error");
            } finally {
                submitBtn.disabled = false;
            }
        };

        window.onload = initConfig;
    </script>
</body>
</html>